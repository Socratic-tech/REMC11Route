<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- ============================================================
       PWA / APP META TAGS
       ============================================================ -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="REMC Routes">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <title id="pageTitle">REMC Field Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background-color: #1a202c;
      color: white;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,.5); }
    .hidden { display: none; }
    .active-tab { background-color: #2563eb !important; color: white !important; }

    /* Stop list status colors */
    .stop-pending  { border-left: 4px solid #eab308; }
    .stop-complete { border-left: 4px solid #22c55e; background-color: #1e3a2a; }
    .stop-skipped  { border-left: 4px solid #ef4444; background-color: #3a1e1e; }

    .stop-item { transition: all 0.2s; cursor: pointer; }
    .stop-item:active { transform: scale(0.98); }
  </style>
</head>
<body class="flex flex-col min-h-screen">

<!-- ============================================================
     HEADER
     ============================================================ -->
<header class="bg-blue-700 p-4 text-center shadow-lg sticky top-0 z-50">
  <h1 id="headerTitle" class="text-xl font-bold tracking-tight uppercase">REMC Field Tool</h1>
  <p id="syncStatus" class="text-xs text-blue-200 mt-1">Initializing...</p>
  <div id="offlineIndicator" class="hidden mt-2 inline-block px-3 py-1 rounded-full text-xs font-bold bg-yellow-500">
    ğŸ“¶ OFFLINE MODE â€“ Photos disabled
  </div>

  <!-- Tab switcher -->
  <div class="flex mt-4 bg-blue-900/50 rounded-lg p-1 max-w-xs mx-auto border border-blue-400/30">
    <button id="tabStop" onclick="switchView('stop')"
      class="flex-1 py-2 text-xs font-bold rounded-md active-tab transition-all">
      CURRENT STOP
    </button>
    <button id="tabList" onclick="switchView('list')"
      class="flex-1 py-2 text-xs font-bold rounded-md text-blue-200 transition-all">
      ALL STOPS
    </button>
  </div>
</header>

<!-- ============================================================
     MAIN CONTENT
     ============================================================ -->
<main class="flex-grow flex flex-col items-center p-4">

  <!-- Loading spinner -->
  <div id="loading" class="mt-20 text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
    <p class="text-gray-400">Loading Route Data...</p>
  </div>

  <!-- â”€â”€ SINGLE STOP VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="stopView" class="hidden w-full max-w-md space-y-4">

    <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 btn-shadow">
      <div class="text-center mb-4">
        <p id="progressText" class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-1">
          Stop 0 of 0
        </p>
        <h2 id="stopName" class="text-2xl font-black leading-tight mb-1">---</h2>
        <p id="addressText" class="text-gray-400 text-sm">---</p>
      </div>

      <!-- Delivery Note -->
      <div id="deliveryNote"
           class="hidden bg-yellow-900/30 border border-yellow-700/50 text-yellow-100 text-sm rounded-xl p-4 my-4">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-lg">ğŸ“¦</span>
          <strong class="uppercase text-xs tracking-tighter">Delivery Note</strong>
        </div>
        <div id="deliveryNoteText" class="italic opacity-90"></div>
      </div>

      <!-- Distance indicator -->
      <div id="distanceBox" class="hidden text-sm text-blue-300 text-center my-2">
        ğŸ“ <span id="distanceText"></span> miles to destination
      </div>

      <!-- Navigation button -->
      <a id="navLink" href="#"
         class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-xl text-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-3 mt-2">
        ğŸ—ºï¸ START NAVIGATION
      </a>

      <!-- Photo button -->
      <button onclick="takePhoto()"
              class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl mt-4 border border-gray-600 transition flex items-center justify-center gap-2">
        <span>ğŸ“·</span>
        <span id="photoBtnText">ATTACH PHOTO</span>
      </button>

      <!-- Photo preview -->
      <div id="photoContainer" class="hidden mt-4 text-center">
        <img id="photoPreview" class="rounded-lg max-h-40 mx-auto border-2 border-green-500" alt="Stop photo">
        <p class="text-green-400 text-xs mt-2 font-bold">âœ“ PHOTO ATTACHED</p>
      </div>

      <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
    </div>

    <!-- Action buttons -->
    <div class="grid grid-cols-2 gap-4">
      <button onclick="handleAction('Complete')"
              class="bg-green-600 hover:bg-green-500 py-6 rounded-2xl font-black text-xl shadow-lg transition transform active:scale-95">
        âœ… DONE
      </button>
      <button onclick="handleAction('Skipped')"
              class="bg-red-600 hover:bg-red-500 py-6 rounded-2xl font-black text-xl shadow-lg transition transform active:scale-95">
        âŒ SKIP
      </button>
    </div>

    <!-- Pending sync indicator -->
    <div id="pendingSync" class="hidden bg-yellow-600 rounded-lg p-3 text-center text-sm">
      <span id="pendingCount">0</span> update(s) waiting to sync
    </div>
  </div>

  <!-- â”€â”€ LIST VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="listView" class="hidden w-full max-w-md">
    <div id="listContainer" class="space-y-3"></div>
  </div>

  <!-- â”€â”€ ROUTE COMPLETE SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="finished" class="hidden text-center space-y-4 mt-20">
    <h2 class="text-4xl font-bold">Route Complete! ğŸ</h2>
    <p class="text-gray-400">All stops for today have been updated.</p>
    <button onclick="switchView('list')"
            class="bg-blue-600 px-6 py-3 rounded-lg font-bold">
      View All Stops
    </button>
    <button onclick="location.reload()"
            class="block mx-auto bg-gray-700 px-6 py-2 rounded-lg mt-2">
      Refresh
    </button>
  </div>

  <!-- â”€â”€ NO DELIVERIES SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="noDeliveries" class="hidden text-center space-y-4 mt-20">
    <h2 class="text-4xl font-bold">ğŸ“¦ No Deliveries Today</h2>
    <p class="text-gray-400">No stops are scheduled for today.</p>
  </div>

</main>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
  // ==============================================================
  // â–¶ CONFIGURATION â€” Edit these two lines before deploying
  // ==============================================================
  const UNIT_NAME  = "REMC";                // e.g. "REMC 4" or "REMC 11"
  const SCRIPT_URL = "PASTE_YOUR_APPS_SCRIPT_URL_HERE";
  // ==============================================================

  // Apply unit name to header and page title
  document.getElementById('headerTitle').innerText = UNIT_NAME + " Field Tool";
  document.getElementById('pageTitle').innerText   = UNIT_NAME + " Field Tool";

  // Runtime state
  let routeData      = [];
  let currentIndex   = 0;
  let currentPhoto   = null;
  let isOnline       = navigator.onLine;
  let pendingUpdates = [];
  let stopStatuses   = {};
  let watchId        = null;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ONLINE / OFFLINE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateOnlineStatus() {
    isOnline = navigator.onLine;
    const indicator = document.getElementById('offlineIndicator');
    const status    = document.getElementById('syncStatus');

    if (isOnline) {
      indicator.classList.add('hidden');
      status.innerText = "âœ… System Online";
      syncPendingUpdates();
    } else {
      indicator.classList.remove('hidden');
      status.innerText = "âš ï¸ Offline â€“ updates queued";
    }
  }

  window.addEventListener('online',  updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PENDING UPDATES (offline queue)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadPendingUpdates() {
    try {
      const stored = localStorage.getItem('pendingUpdates');
      if (stored) { pendingUpdates = JSON.parse(stored); updatePendingDisplay(); }
    } catch (e) {
      localStorage.removeItem('pendingUpdates');
      pendingUpdates = [];
    }
  }

  function savePendingUpdates() {
    try {
      localStorage.setItem('pendingUpdates', JSON.stringify(pendingUpdates));
      updatePendingDisplay();
    } catch (e) { console.error('Error saving pending updates:', e); }
  }

  function updatePendingDisplay() {
    const div = document.getElementById('pendingSync');
    document.getElementById('pendingCount').innerText = pendingUpdates.length;
    pendingUpdates.length > 0 ? div.classList.remove('hidden') : div.classList.add('hidden');
  }

  async function syncPendingUpdates() {
    if (!pendingUpdates.length) return;
    document.getElementById('syncStatus').innerText = `â˜ï¸ Syncing ${pendingUpdates.length} queued update(s)...`;

    const queue = [...pendingUpdates];
    pendingUpdates = [];

    for (const update of queue) {
      try {
        await fetch(update.url, { mode: 'no-cors' });
        await new Promise(r => setTimeout(r, 300));
      } catch (e) {
        pendingUpdates.push(update);
      }
    }

    savePendingUpdates();
    document.getElementById('syncStatus').innerText =
      pendingUpdates.length ? "âš ï¸ Some updates still pending" : "âœ… All updates synced";
  }

  // Auto-retry every 30 seconds while online
  setInterval(() => { if (isOnline && pendingUpdates.length) syncPendingUpdates(); }, 30000);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ROUTE FETCH
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchRoute() {
    // Try cache first if offline
    const cached = localStorage.getItem('routeDataCache');
    if (cached && !navigator.onLine) {
      loadFromCache(JSON.parse(cached));
      document.getElementById('syncStatus').innerText = "ğŸ“¦ Using Cached Route";
      return;
    }

    try {
      const res  = await fetch(SCRIPT_URL);
      const data = await res.json();

      // Cache for offline use
      localStorage.setItem('routeDataCache', JSON.stringify(data));

      // Restore known statuses
      data.forEach(stop => {
        if (stop.Status && stop.Status !== 'Pending') {
          stopStatuses[stop.actualRow] = stop.Status;
        }
      });
      localStorage.setItem('stopStatuses', JSON.stringify(stopStatuses));

      document.getElementById('loading').classList.add('hidden');

      if (!data.length) {
        document.getElementById('noDeliveries').classList.remove('hidden');
        document.getElementById('syncStatus').innerText = "ğŸ“¦ No Deliveries Today";
        return;
      }

      routeData = data.filter(s => {
        const st = (s.Status || "").trim().toLowerCase();
        return st === "" || st === "pending";
      });

      if (routeData.length) {
        renderList();
        updateStopUI();
        document.getElementById('stopView').classList.remove('hidden');
        document.getElementById('syncStatus').innerText = "âœ… System Online";
      } else {
        document.getElementById('finished').classList.remove('hidden');
        document.getElementById('syncStatus').innerText = "ğŸ Route Finished";
      }

    } catch (e) {
      if (cached) {
        loadFromCache(JSON.parse(cached));
        document.getElementById('syncStatus').innerText = "âš ï¸ Offline â€“ Using Cached Route";
      } else {
        document.getElementById('loading').innerHTML =
          "<h2 class='text-red-500 font-bold text-xl'>Connection Error</h2><p class='text-gray-400 mt-2'>No cached data available. Please connect and reload.</p>";
      }
    }
  }

  function loadFromCache(data) {
    const savedStatuses = localStorage.getItem('stopStatuses');
    if (savedStatuses) stopStatuses = JSON.parse(savedStatuses);

    routeData = data.filter(s => {
      const st = (s.Status || "").trim().toLowerCase();
      return st === "" || st === "pending";
    });

    document.getElementById('loading').classList.add('hidden');
    if (routeData.length) {
      renderList();
      updateStopUI();
      document.getElementById('stopView').classList.remove('hidden');
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VIEW SWITCHING
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchView(view) {
    const stopView = document.getElementById('stopView');
    const listView = document.getElementById('listView');
    const tabStop  = document.getElementById('tabStop');
    const tabList  = document.getElementById('tabList');

    if (view === 'stop') {
      stopView.classList.remove('hidden');
      listView.classList.add('hidden');
      tabStop.classList.add('active-tab');
      tabList.classList.remove('active-tab');
      tabList.classList.add('text-blue-200');
    } else {
      stopView.classList.add('hidden');
      listView.classList.remove('hidden');
      tabList.classList.add('active-tab');
      tabList.classList.remove('text-blue-200');
      tabStop.classList.remove('active-tab');
      tabStop.classList.add('text-blue-200');
      renderList();
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // LIST RENDERING
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, m =>
      ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  function renderList() {
    const container = document.getElementById('listContainer');
    if (!routeData.length) {
      container.innerHTML = "<p class='text-gray-400 text-center mt-8'>No pending stops.</p>";
      return;
    }

    container.innerHTML = routeData.map((stop, idx) => {
      const isCurrent = idx === currentIndex;
      const dn = (stop["Delivery Note"] || "").trim();
      return `
        <div onclick="selectStop(${idx})"
             class="stop-item stop-pending bg-gray-800 p-4 rounded-xl border ${isCurrent ? 'border-blue-500 bg-blue-900/20' : 'border-gray-700'}
                    transition active:scale-95">
          <div class="flex justify-between items-center">
            <div class="flex-grow">
              <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">
                Stop ${idx + 1}
                ${isCurrent ? '<span class="ml-2 bg-blue-600 text-white px-2 py-0.5 rounded text-[9px]">CURRENT</span>' : ''}
              </p>
              <h3 class="font-bold text-lg leading-tight mt-0.5">${escapeHtml(stop.Name)}</h3>
              <p class="text-gray-400 text-xs mt-1">${escapeHtml(stop.Address)}</p>
              ${dn ? `<p class="text-xs text-yellow-200 mt-2">ğŸ“¦ ${escapeHtml(dn)}</p>` : ''}
            </div>
            <span class="text-blue-500 ml-3">${isCurrent ? 'ğŸ“' : 'â¡ï¸'}</span>
          </div>
        </div>
      `;
    }).join('');
  }

  function selectStop(idx) {
    currentIndex = idx;
    updateStopUI();
    switchView('stop');
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DISTANCE TRACKING (GPS)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function haversineMiles(lat1, lon1, lat2, lon2) {
    const R   = 3958.8;
    const rad = d => d * Math.PI / 180;
    const dLat = rad(lat2 - lat1);
    const dLon = rad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
      Math.cos(rad(lat1)) * Math.cos(rad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function startDistanceTracking(destLat, destLng) {
    if (!navigator.geolocation) return;
    const box  = document.getElementById('distanceBox');
    const text = document.getElementById('distanceText');
    box.classList.remove('hidden');

    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition(
      pos => {
        const miles = haversineMiles(pos.coords.latitude, pos.coords.longitude, destLat, destLng);
        text.innerText = miles.toFixed(2);
      },
      () => box.classList.add('hidden'),
      { enableHighAccuracy: true, maximumAge: 15000, timeout: 10000 }
    );
  }

  function stopDistanceTracking() {
    document.getElementById('distanceBox').classList.add('hidden');
    if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // STOP UI UPDATE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateStopUI() {
    const stop = routeData[currentIndex];
    if (!stop) return;

    document.getElementById('stopName').innerText    = stop.Name;
    document.getElementById('addressText').innerText = stop.Address;
    document.getElementById('progressText').innerText =
      `Stop ${currentIndex + 1} of ${routeData.length}`;

    // Delivery note
    const dn      = (stop["Delivery Note"] || stop["DeliveryNote"] || "").trim();
    const noteDiv = document.getElementById('deliveryNote');
    if (dn) {
      document.getElementById('deliveryNoteText').innerText = dn;
      noteDiv.classList.remove('hidden');
    } else {
      noteDiv.classList.add('hidden');
    }

    // Navigation link + distance tracking
    const lat = Number(stop.Lat ?? stop.lat);
    const lng = Number(stop.Lng ?? stop.lng);

    if (Number.isFinite(lat) && Number.isFinite(lng) && lat !== 0 && lng !== 0) {
      document.getElementById('navLink').href =
        `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
      startDistanceTracking(lat, lng);
    } else {
      document.getElementById('navLink').href =
        `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.Address)}`;
      stopDistanceTracking();
    }

    // Reset photo
    currentPhoto = null;
    document.getElementById('photoContainer').classList.add('hidden');
    document.getElementById('photoBtnText').innerText = "ATTACH PHOTO";
    document.getElementById('cameraInput').value = '';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PHOTO
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function takePhoto() {
    if (!isOnline) {
      alert("âš ï¸ You must be online to attach photos.");
      return;
    }
    document.getElementById('cameraInput').click();
  }

  document.getElementById('cameraInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      currentPhoto = ev.target.result;
      document.getElementById('photoPreview').src = currentPhoto;
      document.getElementById('photoContainer').classList.remove('hidden');
      document.getElementById('photoBtnText').innerText = "REPLACE PHOTO";
    };
    reader.readAsDataURL(file);
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ACTIONS (Complete / Skip)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleAction(status) {
    const stop = routeData[currentIndex];
    let note = "";

    if (status === "Skipped") {
      note = prompt("Reason for skipping?") || "No reason provided";
    }

    // Track locally
    stopStatuses[stop.actualRow] = status;
    localStorage.setItem('stopStatuses', JSON.stringify(stopStatuses));

    const syncStatus = document.getElementById('syncStatus');

    if (isOnline) {
      syncStatus.innerText = "â˜ï¸ Syncing...";

      try {
        if (currentPhoto) {
          // POST for photo uploads
          const payload = {
            rowID:    stop.actualRow,
            status:   status,
            note:     note,
            stopName: stop.Name,
            routeDay: stop.routeDay,
            photo:    currentPhoto
          };
          await fetch(SCRIPT_URL, {
            method: "POST",
            mode:   "no-cors",
            body:   JSON.stringify(payload)
          });
          await new Promise(r => setTimeout(r, 1200));
          syncStatus.innerText = "âœ… Photo Uploaded";

        } else {
          // GET for simple status updates (faster)
          const url = `${SCRIPT_URL}?rowID=${stop.actualRow}&status=${status}&note=${encodeURIComponent(note)}&routeDay=${encodeURIComponent(stop.routeDay || "")}`;
          await fetch(url, { mode: 'no-cors' });
          await new Promise(r => setTimeout(r, 400));
          syncStatus.innerText = "âœ… Saved to Sheet";
        }

      } catch (e) {
        // Queue for retry if no photo
        if (!currentPhoto) {
          pendingUpdates.push({
            url: `${SCRIPT_URL}?rowID=${stop.actualRow}&status=${status}&note=${encodeURIComponent(note)}&routeDay=${encodeURIComponent(stop.routeDay || "")}`,
          });
          savePendingUpdates();
        }
        syncStatus.innerText = currentPhoto ? "âš ï¸ Photo upload failed" : "âš ï¸ Queued for sync";
      }

    } else {
      if (currentPhoto) {
        alert("âš ï¸ Cannot upload photo while offline. Reconnect and try again.");
      }
      pendingUpdates.push({
        url: `${SCRIPT_URL}?rowID=${stop.actualRow}&status=${status}&note=${encodeURIComponent(note)}&routeDay=${encodeURIComponent(stop.routeDay || "")}`,
      });
      savePendingUpdates();
      syncStatus.innerText = "ğŸ’¾ Saved Locally";
    }

    // Advance to next stop
    routeData.splice(currentIndex, 1);

    if (routeData.length > 0) {
      if (currentIndex >= routeData.length) currentIndex = routeData.length - 1;
      renderList();
      updateStopUI();
    } else {
      stopDistanceTracking();
      document.getElementById('stopView').classList.add('hidden');
      document.getElementById('finished').classList.remove('hidden');
      syncStatus.innerText = pendingUpdates.length
        ? `âœ… Route Complete â€“ ${pendingUpdates.length} pending sync`
        : "âœ… Route Complete";
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // INIT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadPendingUpdates();
  updateOnlineStatus();
  fetchRoute();
</script>

</body>
</html>
