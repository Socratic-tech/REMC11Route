<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>REMC Route Tool</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="REMC Routes">
<link rel="apple-touch-icon" href="/icon-192.png">

<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#1a202c; color:white; font-family:sans-serif; }
.btn-shadow { box-shadow:0 4px 6px rgba(0,0,0,.5); }
.hidden { display:none; }
.stop-item { transition:.15s; cursor:pointer; }
.stop-item:active { transform:scale(.98); }
.stop-pending { border-left:4px solid #eab308; }
.stop-complete { border-left:4px solid #22c55e; background:#1e3a2a; }
.stop-skipped { border-left:4px solid #ef4444; background:#3a1e1e; }
#photoPreview { max-width:100%; border-radius:8px; margin-top:10px; }
</style>
</head>

<body class="flex flex-col min-h-screen">

<header class="bg-blue-700 p-4 text-center shadow-lg">
<h1 class="text-xl font-bold">REMC FIELD TOOL</h1>
<p id="syncStatus" class="text-xs mt-1">Checking connection‚Ä¶</p>
<div id="offlineIndicator" class="hidden mt-2 px-3 py-1 rounded text-xs bg-yellow-500">
üì∂ OFFLINE MODE ‚Äì Photos disabled
</div>
</header>

<main class="flex-grow p-6 flex flex-col items-center">

<div id="loading" class="text-center">
<div class="animate-spin h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
<p>Loading Today‚Äôs Route‚Ä¶</p>
</div>

<!-- LIST VIEW -->
<div id="listView" class="hidden w-full max-w-2xl">
<div class="flex justify-between mb-4">
<h2 class="text-2xl font-bold">Today‚Äôs Stops</h2>
<button onclick="showCurrentStop()" class="bg-blue-600 px-4 py-2 rounded">Return</button>
</div>
<div id="stopsList" class="space-y-3"></div>
</div>

<!-- STOP VIEW -->
<div id="app" class="hidden w-full max-w-md space-y-6">

<div class="flex justify-between">
<button onclick="showListView()" class="bg-gray-700 px-4 py-2 rounded">üìã Stops</button>
<button id="backButton" onclick="goBack()" class="hidden bg-gray-700 px-4 py-2 rounded">‚¨Ö Back</button>
</div>

<div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 btn-shadow text-center">
<p id="progressText" class="text-blue-400 text-sm mb-2"></p>
<h2 id="stopName" class="text-3xl font-bold mb-2">---</h2>
<p id="addressText" class="text-gray-400 mb-6">---</p>

<a id="navLink" target="_blank"
class="block bg-blue-600 py-4 rounded-xl text-xl font-bold mb-4">
üó∫ OPEN NAVIGATION
</a>

<button onclick="takePhoto()" id="photoButton"
class="bg-purple-600 py-3 rounded-xl text-lg font-bold w-full">
üì∑ TAKE PHOTO
</button>

<div id="photoContainer" class="hidden mt-4">
<img id="photoPreview">
<p class="text-green-400 text-sm mt-1">‚úì Photo ready</p>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
</div>

<div class="grid grid-cols-2 gap-4">
<button onclick="handleAction('Complete')" class="bg-green-600 py-6 rounded-xl text-xl font-bold">‚úÖ DONE</button>
<button onclick="handleAction('Skipped')" class="bg-red-600 py-6 rounded-xl text-xl font-bold">‚ùå SKIP</button>
</div>

<div id="pendingSync" class="hidden bg-yellow-600 p-3 rounded text-center text-sm">
<span id="pendingCount">0</span> updates pending
</div>

</div>

<div id="finished" class="hidden text-center space-y-4">
<h2 class="text-4xl font-bold">Route Complete!</h2>
<button onclick="showListView()" class="bg-blue-600 px-6 py-3 rounded">View Stops</button>
</div>

</main>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbwlOPC1U5DtR3xcIXaCY0fBedy5tLdhTUh276O4MEGsVgrWnsqfHJtfqkBKtpN_qe60ow/exec';

let routeData=[], currentIndex=0, pendingUpdates=[], currentPhoto=null;
let stopStatuses={}, isOnline=navigator.onLine;

/* ---------- IMAGE RESIZE ---------- */
function resizeImage(file,max=1280,quality=.75){
return new Promise(res=>{
const img=new Image(),r=new FileReader();
r.onload=e=>{
img.onload=()=>{
let w=img.width,h=img.height;
if(w>h&&w>max){h*=max/w;w=max;}
else if(h>max){w*=max/h;h=max;}
const c=document.createElement('canvas');
c.width=w;c.height=h;
c.getContext('2d').drawImage(img,0,0,w,h);
res(c.toDataURL('image/jpeg',quality));
};
img.src=e.target.result;
};
r.readAsDataURL(file);
});
}

/* ---------- PHOTO ---------- */
function takePhoto(){
if(!isOnline){alert("Online required for photos.");return;}
cameraInput.click();
}

cameraInput.onchange=e=>{
const file=e.target.files[0];
if(!file)return;
syncStatus.innerText="üì∑ Compressing photo‚Ä¶";
resizeImage(file).then(data=>{
currentPhoto=data;
photoPreview.src=data;
photoContainer.classList.remove('hidden');
syncStatus.innerText="üì∑ Photo ready";
});
};

/* ---------- UI ---------- */
function updateUI(){
const s=routeData[currentIndex];
stopName.innerText=s.Name;
addressText.innerText=s.Address;
navLink.href=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.Address)}`;
progressText.innerText=`Stop ${currentIndex+1} of ${routeData.length}`;
backButton.classList.toggle('hidden',currentIndex===0);
photoContainer.classList.add('hidden');
currentPhoto=null;
cameraInput.value="";
}

/* ---------- ACTION ---------- */
function handleAction(status){
const stop=routeData[currentIndex];
let note="";
if(status==="Skipped")note=prompt("Reason?")||"";

stopStatuses[stop.actualRow]=status;
localStorage.setItem('stopStatuses',JSON.stringify(stopStatuses));

currentIndex++;
currentIndex<routeData.length?updateUI():
(app.classList.add('hidden'),finished.classList.remove('hidden'));

backgroundSync(stop,status,note);
}

/* ---------- BACKGROUND SYNC ---------- */
async function backgroundSync(stop,status,note){
if(!isOnline){queue(stop,status,note);return;}
try{
if(currentPhoto){
await fetch(scriptURL,{method:'POST',mode:'no-cors',
body:JSON.stringify({rowID:stop.actualRow,status,note,photo:currentPhoto}),
headers:{'Content-Type':'application/json'}});
}else{
await fetch(`${scriptURL}?rowID=${stop.actualRow}&status=${status}&note=${encodeURIComponent(note)}`,{mode:'no-cors'});
}
syncStatus.innerText="‚úÖ Synced";
}catch{queue(stop,status,note);}
}

/* ---------- QUEUE ---------- */
function queue(stop,status,note){
pendingUpdates.push({url:`${scriptURL}?rowID=${stop.actualRow}&status=${status}&note=${encodeURIComponent(note)}`});
localStorage.setItem('pendingUpdates',JSON.stringify(pendingUpdates));
pendingCount.innerText=pendingUpdates.length;
pendingSync.classList.remove('hidden');
syncStatus.innerText="üíæ Saved for sync";
}

/* ---------- FETCH ROUTE ---------- */
async function fetchRoute(){
const res=await fetch(scriptURL);
const data=await res.json();
routeData=data.filter(s=>!s.Status||s.Status==="Pending");
loading.classList.add('hidden');
routeData.length?(app.classList.remove('hidden'),updateUI()):
finished.classList.remove('hidden');
syncStatus.innerText="‚úÖ Ready";
}

/* ---------- ONLINE ---------- */
window.addEventListener('online',()=>location.reload());
window.addEventListener('offline',()=>offlineIndicator.classList.remove('hidden'));

fetchRoute();
</script>

</body>
</html>
