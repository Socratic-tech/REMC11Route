<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  >
  <title>REMC Route Tool</title>

  <!-- PWA Meta -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="REMC Routes">
  <link rel="apple-touch-icon" href="/icon-192.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background-color: #1a202c;
      color: white;
      font-family: system-ui, sans-serif;
    }

    .btn-shadow {
      box-shadow: 0 4px 6px -1px rgba(0,0,0,.5);
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body class="flex flex-col min-h-screen">

<header class="bg-blue-700 p-4 text-center shadow-lg">
  <h1 class="text-xl font-bold tracking-tight">REMC FIELD TOOL</h1>
  <p id="syncStatus" class="text-xs text-blue-200 mt-1">Loading‚Ä¶</p>
</header>

<main class="flex-grow flex flex-col items-center p-6">

  <!-- LOADING -->
  <div id="loading" class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
    <p class="text-lg">Loading Today's Route‚Ä¶</p>
  </div>

  <!-- STOP VIEW -->
  <div id="app" class="hidden w-full max-w-md space-y-6">

    <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 btn-shadow text-center">

      <p
        id="progressText"
        class="text-blue-400 text-sm font-bold mb-2 uppercase tracking-widest"
      >
        Stop --
      </p>

      <h2 id="stopName" class="text-3xl font-extrabold mb-2">---</h2>
      <p id="addressText" class="text-gray-400 text-lg mb-2">---</p>

      <!-- DELIVERY NOTE (NEW) -->
      <div
        id="deliveryNote"
        class="hidden bg-yellow-900/40 border border-yellow-700 text-yellow-200 text-sm rounded-lg p-3 mt-3 text-left"
      >
        <strong>üì¶ Delivery Note</strong>
        <div id="deliveryNoteText" class="mt-1"></div>
      </div>

      <a
        id="navLink"
        href="#"
        target="_blank"
        class="inline-block bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-xl w-full text-xl transition transform active:scale-95 btn-shadow mt-4"
      >
        üó∫Ô∏è OPEN NAVIGATION
      </a>

      <button
        onclick="takePhoto()"
        id="photoButton"
        class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-xl w-full text-lg transition transform active:scale-95 btn-shadow mt-4"
      >
        üì∑ TAKE PHOTO
      </button>

      <div id="photoContainer" class="hidden mt-4">
        <img id="photoPreview" class="rounded-lg">
        <p class="text-green-400 text-sm mt-2">‚úì Photo ready</p>
      </div>

      <input
        type="file"
        id="cameraInput"
        accept="image/*"
        capture="environment"
        class="hidden"
      >
    </div>

    <div class="grid grid-cols-2 gap-4">
      <button
        onclick="handleAction('Complete')"
        class="bg-green-600 hover:bg-green-500 py-6 rounded-xl font-bold text-xl btn-shadow transition transform active:scale-95"
      >
        ‚úÖ DONE
      </button>
      <button
        onclick="handleAction('Skipped')"
        class="bg-red-600 hover:bg-red-500 py-6 rounded-xl font-bold text-xl btn-shadow transition transform active:scale-95"
      >
        ‚ùå SKIP
      </button>
    </div>
  </div>

</main>

<script>
/**********************************************************
 * CONFIG
 **********************************************************/
const scriptURL =
  "https://script.google.com/macros/s/AKfycbwlOPC1U5DtR3xcIXaCY0fBedy5tLdhTUh276O4MEGsVgrWnsqfHJtfqkBKtpN_qe60ow/exec";

let routeData = [];
let currentIndex = 0;
let currentPhoto = null;

/**********************************************************
 * FETCH ROUTE
 **********************************************************/
async function fetchRoute() {
  try {
    const res = await fetch(scriptURL);
    routeData = await res.json();

    document.getElementById("loading").classList.add("hidden");

    if (!routeData.length) {
      document.getElementById("syncStatus").innerText = "No stops today";
      return;
    }

    document.getElementById("app").classList.remove("hidden");
    updateUI();
  } catch (e) {
    document.getElementById("syncStatus").innerText = "Error loading route";
  }
}

/**********************************************************
 * UI UPDATE
 **********************************************************/
function updateUI() {
  const stop = routeData[currentIndex];

  document.getElementById("stopName").innerText = stop.Name;
  document.getElementById("addressText").innerText = stop.Address;
  document.getElementById("progressText").innerText =
    `Stop ${currentIndex + 1} of ${routeData.length}`;

  document.getElementById("navLink").href =
    `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.Address)}`;

  // DELIVERY NOTE LOGIC (NEW)
  const noteBox = document.getElementById("deliveryNote");
  const noteText = document.getElementById("deliveryNoteText");

  const deliveryNote =
    stop["Delivery Note"] ||
    stop["DeliveryNote"] ||
    "";

  if (deliveryNote && deliveryNote.trim() !== "") {
    noteText.innerText = deliveryNote;
    noteBox.classList.remove("hidden");
  } else {
    noteText.innerText = "";
    noteBox.classList.add("hidden");
  }

  // Reset photo
  currentPhoto = null;
  document.getElementById("photoContainer").classList.add("hidden");
  document.getElementById("cameraInput").value = "";
}

/**********************************************************
 * PHOTO HANDLING
 **********************************************************/
function takePhoto() {
  document.getElementById("cameraInput").click();
}

document.getElementById("cameraInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    currentPhoto = ev.target.result;
    document.getElementById("photoPreview").src = currentPhoto;
    document.getElementById("photoContainer").classList.remove("hidden");
  };
  reader.readAsDataURL(file);
});

/**********************************************************
 * COMPLETE / SKIP
 **********************************************************/
async function handleAction(status) {
  const stop = routeData[currentIndex];
  let note = "";

  if (status === "Skipped") {
    note = prompt("Reason for skipping?") || "";
  }

  const payload = {
    rowID: stop.actualRow,
    status,
    note,
    stopName: stop.Name,
    photo: currentPhoto || ""
  };

  await fetch(scriptURL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify(payload),
    headers: { "Content-Type": "application/json" }
  });

  currentIndex++;
  if (currentIndex < routeData.length) {
    updateUI();
  } else {
    document.getElementById("syncStatus").innerText = "Route complete";
    document.getElementById("app").classList.add("hidden");
  }
}

/**********************************************************
 * INIT
 **********************************************************/
fetchRoute();
</script>

</body>
</html>
