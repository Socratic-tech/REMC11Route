<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REMC Route Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a202c; color: white; font-family: sans-serif; }
        .btn-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .hidden { display: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-blue-700 p-4 text-center shadow-lg">
        <h1 class="text-xl font-bold tracking-tight">REMC FIELD TOOL</h1>
        <p id="syncStatus" class="text-xs text-blue-200 mt-1">Checking connection...</p>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center p-6">
        
        <div id="loading" class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <p class="text-lg">Loading Today's Route...</p>
        </div>

        <div id="app" class="hidden w-full max-w-md space-y-6">
            <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 btn-shadow text-center">
                <p id="progressText" class="text-blue-400 text-sm font-bold mb-2 uppercase tracking-widest">Stop 1 of --</p>
                <h2 id="stopName" class="text-3xl font-extrabold mb-2">---</h2>
                <p id="addressText" class="text-gray-400 text-lg mb-6">---</p>
                
                <a id="navLink" href="#" target="_blank" 
                   class="inline-block bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-xl w-full text-xl transition transform active:scale-95 btn-shadow">
                    üó∫Ô∏è OPEN NAVIGATION
                </a>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="handleAction('Completed')" 
                        class="bg-green-600 hover:bg-green-500 py-6 rounded-xl font-bold text-xl btn-shadow transition transform active:scale-95">
                    ‚úÖ DONE
                </button>
                <button onclick="handleAction('Skipped')" 
                        class="bg-red-600 hover:bg-red-500 py-6 rounded-xl font-bold text-xl btn-shadow transition transform active:scale-95">
                    ‚ùå SKIP
                </button>
            </div>
        </div>

        <div id="finished" class="hidden text-center space-y-4">
            <h2 class="text-4xl font-bold">Route Complete!</h2>
            <p class="text-gray-400">All stops for today have been updated.</p>
            <button onclick="location.reload()" class="bg-gray-700 px-6 py-2 rounded-lg">Refresh List</button>
        </div>
    </main>

    <script>
        // PASTE YOUR NEW /exec URL BELOW
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxiCWnOKYu1S7os0R-YXVxfdnPEMbRZzo8z98lbDOZ3L3vqiVeqEcPkszJM-zV4_ipnaA/exec';
        
        let routeData = [];
        let currentIndex = 0;

        async function fetchRoute() {
            try {
                const response = await fetch(scriptURL);
                const data = await response.json();
                
                // Filter for Pending stops
                routeData = data.filter(stop => stop.Status === "Pending");
                
                document.getElementById('loading').classList.add('hidden');
                if (routeData.length > 0) {
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('syncStatus').innerText = "‚úÖ System Online";
                    updateUI();
                } else {
                    document.getElementById('finished').classList.remove('hidden');
                    document.getElementById('syncStatus').innerText = "üèÅ Route Finished";
                }
            } catch (e) {
                document.getElementById('loading').innerHTML = "<h2 class='text-red-500 font-bold'>Connection Error</h2><p>Check your deployment URL.</p>";
                console.error(e);
            }
        }

        function updateUI() {
            const stop = routeData[currentIndex];
            document.getElementById('stopName').innerText = stop.Name;
            document.getElementById('addressText').innerText = stop.Address;
            document.getElementById('navLink').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.Address)}`;
            document.getElementById('progressText').innerText = `Stop ${currentIndex + 1} of ${routeData.length}`;
        }
async function handleAction(status) {
    const stop = routeData[currentIndex];
    let note = "";
    if (status === 'Skipped') {
        note = prompt("Reason for skipping?") || "No reason provided";
    }

    document.getElementById('syncStatus').innerText = "‚òÅÔ∏è Syncing...";

    // This matches the format that just gave you the "Success" message
    const updateURL = `${scriptURL}?rowID=${stop.actualRow}&status=${status}&note=${encodeURIComponent(note)}`;

    // Using 'no-cors' allows the request to fire even if Google redirects it
    fetch(updateURL, { mode: 'no-cors' });

    // Move the UI forward immediately so the driver isn't waiting
    currentIndex++;
    if (currentIndex < routeData.length) {
        updateUI();
        document.getElementById('syncStatus').innerText = "‚úÖ Sent to Sheet";
    } else {
        document.getElementById('app').classList.add('hidden');
        document.getElementById('finished').classList.remove('hidden');
        document.getElementById('syncStatus').innerText = "üèÅ Route Complete";
    }
}         
            const payload = {
                rowID: stop.actualRow, // Laser-guided Row ID from the script
                status: status,
                note: note
            };

            // Send to Google Sheets
            fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });

            // Optimistic UI move to next stop
            currentIndex++;
            if (currentIndex < routeData.length) {
                updateUI();
                document.getElementById('syncStatus').innerText = "‚úÖ Sent to Sheet";
            } else {
                document.getElementById('app').classList.add('hidden');
                document.getElementById('finished').classList.remove('hidden');
                document.getElementById('syncStatus').innerText = "‚úÖ Final Stop Synced";
            }
        }

        fetchRoute();
    </script>
</body>
</html>
