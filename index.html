<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>REMC Route Tool</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" href="/icon-192.png">

<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#1a202c; color:white; font-family:sans-serif; }
.hidden { display:none; }
.btn-shadow { box-shadow:0 4px 6px rgba(0,0,0,.5); }
.stop-item { cursor:pointer; transition:.15s; }
.stop-item:active { transform:scale(.98); }
.stop-pending { border-left:4px solid #eab308; }
.stop-complete { border-left:4px solid #22c55e; background:#1e3a2a; }
.stop-skipped { border-left:4px solid #ef4444; background:#3a1e1e; }
#photoPreview { max-width:100%; border-radius:8px; margin-top:10px; }
</style>
</head>

<body class="flex flex-col min-h-screen">

<header class="bg-blue-700 p-4 text-center shadow-lg">
  <h1 class="text-xl font-bold">REMC FIELD TOOL</h1>
  <p id="syncStatus" class="text-xs mt-1">Starting‚Ä¶</p>
</header>

<main class="flex-grow p-6 flex flex-col items-center">

<div id="loading" class="text-center">
  <p>Loading route‚Ä¶</p>
</div>

<!-- LIST VIEW -->
<div id="listView" class="hidden w-full max-w-2xl">
  <div class="flex justify-between mb-4">
    <h2 class="text-2xl font-bold">Today‚Äôs Stops</h2>
    <button onclick="showCurrentStop()" class="bg-blue-600 px-4 py-2 rounded">Return</button>
  </div>
  <div id="stopsList" class="space-y-3"></div>
</div>

<!-- STOP VIEW -->
<div id="app" class="hidden w-full max-w-md space-y-6">

  <div class="flex justify-between">
    <button onclick="showListView()" class="bg-gray-700 px-4 py-2 rounded">üìã View Stops</button>
    <button id="backButton" onclick="goBack()" class="hidden bg-gray-700 px-4 py-2 rounded">‚¨Ö Back</button>
  </div>

  <div class="bg-gray-800 p-6 rounded-xl text-center btn-shadow">
    <p id="progressText" class="text-sm text-blue-400"></p>
    <h2 id="stopName" class="text-3xl font-bold mb-2">---</h2>
    <p id="addressText" class="text-gray-400 mb-4">---</p>

    <a id="navLink" target="_blank"
       class="block bg-blue-600 py-3 rounded-xl font-bold mb-4">
       üó∫ OPEN NAVIGATION
    </a>

    <button onclick="takePhoto()" class="bg-purple-600 py-3 rounded-xl w-full font-bold">
      üì∑ TAKE PHOTO
    </button>

    <div id="photoContainer" class="hidden mt-4">
      <img id="photoPreview">
      <p class="text-green-400 text-sm mt-1">‚úì Photo ready</p>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
  </div>

  <div class="grid grid-cols-2 gap-4">
    <button onclick="handleAction('Complete')" class="bg-green-600 py-6 rounded-xl font-bold">
      ‚úÖ DONE
    </button>
    <button onclick="handleAction('Skipped')" class="bg-red-600 py-6 rounded-xl font-bold">
      ‚ùå SKIP
    </button>
  </div>

</div>

<div id="finished" class="hidden text-center space-y-4">
  <h2 class="text-4xl font-bold">Route Complete</h2>
</div>

</main>

<script>
/* ================= CONFIG ================= */
const scriptURL = 'https://script.google.com/macros/s/AKfycbwlOPC1U5DtR3xcIXaCY0fBedy5tLdhTUh276O4MEGsVgrWnsqfHJtfqkBKtpN_qe60ow/exec';

/* ================= DOM ================= */
const el = {
  loading: document.getElementById('loading'),
  app: document.getElementById('app'),
  listView: document.getElementById('listView'),
  finished: document.getElementById('finished'),
  stopsList: document.getElementById('stopsList'),
  stopName: document.getElementById('stopName'),
  addressText: document.getElementById('addressText'),
  progressText: document.getElementById('progressText'),
  navLink: document.getElementById('navLink'),
  backButton: document.getElementById('backButton'),
  cameraInput: document.getElementById('cameraInput'),
  photoPreview: document.getElementById('photoPreview'),
  photoContainer: document.getElementById('photoContainer'),
  syncStatus: document.getElementById('syncStatus')
};

/* ================= STATE ================= */
let routeData = [];
let currentIndex = 0;
let currentPhoto = null;
let stopStatuses = JSON.parse(localStorage.getItem('stopStatuses') || '{}');

/* ================= IMAGE RESIZE ================= */
function resizeImage(file, max = 1280, quality = 0.75) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => {
      img.onload = () => {
        let w = img.width, h = img.height;
        if (w > h && w > max) { h *= max / w; w = max; }
        else if (h > max) { w *= max / h; h = max; }

        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL('image/jpeg', quality));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

/* ================= PHOTO ================= */
function takePhoto() {
  el.cameraInput.click();
}

el.cameraInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  el.syncStatus.innerText = "üì∑ Compressing photo‚Ä¶";
  resizeImage(file).then(data => {
    currentPhoto = data;
    el.photoPreview.src = data;
    el.photoContainer.classList.remove('hidden');
    el.syncStatus.innerText = "üì∑ Photo ready";
  });
});

/* ================= VIEWS ================= */
function showListView() {
  el.app.classList.add('hidden');
  el.finished.classList.add('hidden');
  el.listView.classList.remove('hidden');
  renderStopsList();
}

function showCurrentStop() {
  el.listView.classList.add('hidden');
  currentIndex < routeData.length
    ? el.app.classList.remove('hidden')
    : el.finished.classList.remove('hidden');
}

function goBack() {
  if (currentIndex > 0) {
    currentIndex--;
    updateUI();
  }
}

/* ================= LIST ================= */
function renderStopsList() {
  el.stopsList.innerHTML = '';
  routeData.forEach((s, i) => {
    const status = stopStatuses[s.actualRow] || 'Pending';
    const cls = status === 'Complete' ? 'stop-complete'
      : status === 'Skipped' ? 'stop-skipped'
      : 'stop-pending';

    const div = document.createElement('div');
    div.className = `stop-item ${cls} bg-gray-800 p-4 rounded`;
    div.onclick = () => {
      currentIndex = i;
      showCurrentStop();
      updateUI();
    };

    div.innerHTML = `
      <p class="text-sm text-blue-400">Stop ${i + 1}</p>
      <h3 class="font-bold">${s.Name}</h3>
      <p class="text-sm text-gray-400">${s.Address}</p>
    `;
    el.stopsList.appendChild(div);
  });
}

/* ================= UI ================= */
function updateUI() {
  const s = routeData[currentIndex];
  el.stopName.innerText = s.Name;
  el.addressText.innerText = s.Address;
  el.navLink.href =
    `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.Address)}`;
  el.progressText.innerText = `Stop ${currentIndex + 1} of ${routeData.length}`;
  el.backButton.classList.toggle('hidden', currentIndex === 0);
  el.photoContainer.classList.add('hidden');
  currentPhoto = null;
  el.cameraInput.value = '';
}

/* ================= SHEET UPDATE ================= */
async function sendUpdateToSheet(stop, status, note, photoData) {
  try {
    if (photoData) {
      await fetch(scriptURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          rowID: stop.actualRow,
          status,
          note,
          stopName: stop.Name,
          photo: photoData
        })
      });
    } else {
      await fetch(
        `${scriptURL}?rowID=${stop.actualRow}&status=${encodeURIComponent(status)}&note=${encodeURIComponent(note)}`,
        { mode: "no-cors" }
      );
    }
    el.syncStatus.innerText = "‚úÖ Sent to Sheet";
  } catch (e) {
    console.error(e);
    el.syncStatus.innerText = "‚ö†Ô∏è Update failed";
  }
}

/* ================= ACTION ================= */
function handleAction(status) {
  const stop = routeData[currentIndex];
  const photoSnapshot = currentPhoto; // ‚úÖ capture BEFORE clearing
  let note = "";

  if (status === "Skipped") {
    note = prompt("Reason for skipping?") || "";
  }

  stopStatuses[stop.actualRow] = status;
  localStorage.setItem('stopStatuses', JSON.stringify(stopStatuses));

  currentIndex++;
  currentIndex < routeData.length
    ? updateUI()
    : (el.app.classList.add('hidden'), el.finished.classList.remove('hidden'));
const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
const filenameStopName = `${today}_${stop.Name}`;
  sendUpdateToSheet(stop, status, note, photoSnapshot);
}

/* ================= FETCH ================= */
async function fetchRoute() {
  try {
    const res = await fetch(scriptURL);
    const data = await res.json();
    routeData = data.filter(s => !s.Status || s.Status === "Pending");
    el.loading.classList.add('hidden');
    routeData.length
      ? (el.app.classList.remove('hidden'), updateUI())
      : el.finished.classList.remove('hidden');
    el.syncStatus.innerText = "‚úÖ Ready";
  } catch (e) {
    console.error(e);
    el.loading.innerHTML = "<p class='text-red-400'>Failed to load route</p>";
  }
}

fetchRoute();
</script>

</body>
</html>
