<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>REMC Daily Route Review</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
</script>

<script src="https://cdn.tailwindcss.com"></script>

<style>
#map { height: 80vh; }
</style>
</head>

<body class="bg-gray-100 text-gray-900">

<header class="bg-blue-700 text-white p-4 text-center">
  <h1 class="text-xl font-bold">Daily Route Review</h1>
</header>

<div class="p-4 flex gap-4 items-center">
  <input type="date" id="datePicker" class="border p-2 rounded">
  <button onclick="loadData()" class="bg-blue-600 text-white px-4 py-2 rounded">
    Load Day
  </button>
</div>

<div id="map"></div>

<script>
const scriptURL =
  "https://script.google.com/macros/s/AKfycbwlOPC1U5DtR3xcIXaCY0fBedy5tLdhTUh276O4MEGsVgrWnsqfHJtfqkBKtpN_qe60ow/exec";

function todayISO() {
  const d = new Date();
  return d.toISOString().split("T")[0];
}

  window.onload = () => {
  document.getElementById("datePicker").value = todayISO();
  loadData(); // ðŸ‘ˆ auto-load today
};

let map = L.map("map").setView([42.1, -86.4], 10);
let markers = [];

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap contributors"
}).addTo(map);

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

async function loadData() {
  clearMarkers();

  const date = document.getElementById("datePicker").value;
  if (!date) {
    alert("Pick a date");
    return;
  }

  const res = await fetch(`${scriptURL}?mode=dailySummary&date=${date}`);
  const data = await res.json();

  if (data.length === 0) {
    alert("No stops for this date");
    return;
  }

  const bounds = [];

  data.forEach(stop => {
    if (!stop.lat || !stop.lng) return;

    const color = stop.status === "Complete" ? "green" : "red";

    const marker = L.circleMarker([stop.lat, stop.lng], {
      radius: 8,
      color,
      fillColor: color,
      fillOpacity: 0.9
    }).addTo(map);

    marker.bindPopup(`
      <strong>${stop.name}</strong><br>
      ${stop.address}<br>
      Status: ${stop.status}<br>
      ${stop.photo
        ? `<a href="${stop.photo}" target="_blank">ðŸ“· View Photo</a>`
        : "No photo"}
    `);

    markers.push(marker);
    bounds.push([stop.lat, stop.lng]);
  });

  if (bounds.length) {
    map.fitBounds(bounds, { padding: [30, 30] });
  }
}
</script>

</body>
</html>
